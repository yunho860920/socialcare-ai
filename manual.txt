<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialCare AI - Îß•ÎùΩ Ïù∏Ïãù Î≤ÑÏ†Ñ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg-color: #121212; --chat-bg: #1e1e1e; --input-bg: #2d2d2d; --accent-color: #0052cc; --text-color: #e0e0e0; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; line-height: 1.6; }
        
        header { padding: 15px 20px; background: var(--chat-bg); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .title { font-weight: 700; font-size: 1.1rem; color: #fff; display: flex; align-items: center; gap: 10px; }
        
        .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; background: #333; color: #aaa; border: 1px solid #444; }
        .status-badge.active { background: #1b5e20; color: #a5d6a7; border-color: #2e7d32; }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 12px; max-width: 85%; word-break: break-word; font-size: 0.95rem; }
        .system { background: #263238; color: #b0bec5; text-align: center; align-self: center; font-size: 0.85rem; padding: 8px 15px; border-radius: 20px; }
        .ai { background: #2d2d2d; border-left: 3px solid #4facfe; align-self: flex-start; }
        .user { background: var(--accent-color); color: white; align-self: flex-end; }
        
        .ai strong { color: #64b5f6; }
        .ai ul, .ai ol { padding-left: 20px; margin: 5px 0; }

        #input-area { padding: 20px; background: var(--chat-bg); border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #444; background: var(--input-bg); color: white; font-size: 16px; outline: none; }
        button { padding: 0 25px; border-radius: 10px; border: none; background: var(--accent-color); color: white; font-weight: bold; cursor: pointer; white-space: nowrap; }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.7; }
        
        #progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #333; display: none; }
        #progress-bar { height: 100%; background: #4facfe; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<header>
    <div class="title">üõ°Ô∏è Î≥¥Ïïà ÏïàÏã¨ Îß§Îâ¥Ïñº ÎπÑÏÑú</div>
    <span id="status-text" class="status-badge">Î™®Îç∏ Ï§ÄÎπÑ Ï§ë...</span>
</header>

<div id="chat-box"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="AI ÏóîÏßÑÏùÑ Îã§Ïö¥Î°úÎìúÌïòÍ≥† ÏûàÏäµÎãàÎã§..." disabled>
    <button id="btn-send" disabled>Ï†ÑÏÜ°</button>
</div>

<script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    const SELECTED_MODEL = "Llama-3.2-1B-Instruct-q4f16_1-MLC";

    let engine = null;
    let manualContent = "";
    // [ÌïµÏã¨] ÎåÄÌôî ÎÇ¥Ïö©ÏùÑ Í∏∞ÏñµÌï† Ï†ÄÏû•ÏÜå Ï∂îÍ∞Ä
    let conversationHistory = []; 
    
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('btn-send');
    const statusText = document.getElementById('status-text');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');

    function addMessage(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        if (type === 'ai') div.innerHTML = marked.parse(text);
        else div.textContent = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function initialize() {
        progressContainer.style.display = 'block';
        try {
            addMessage("system", "üìÇ manual.txt ÌååÏùº ÏùΩÎäî Ï§ë...");
            const res = await fetch('manual.txt?v=' + Date.now());
            if (!res.ok) throw new Error("manual.txt ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.");
            manualContent = await res.text();
            addMessage("system", "‚úÖ Îß§Îâ¥Ïñº Î°úÎìú ÏôÑÎ£å.");

            addMessage("system", "üöÄ AI ÏóîÏßÑ Íµ¨Îèô ÏãúÏûë... (Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî)");
            
            engine = await CreateMLCEngine(
                SELECTED_MODEL,
                {
                    initProgressCallback: (report) => {
                        const percent = report.progress * 100;
                        progressBar.style.width = `${percent}%`;
                        statusText.textContent = `Îã§Ïö¥Î°úÎìú: ${Math.round(percent)}%`;
                        if (report.progress === 1.0) statusText.textContent = "üü¢ ÎåÄÌôî Ï§ÄÎπÑ ÏôÑÎ£å";
                    }
                }
            );

            progressContainer.style.display = 'none';
            statusText.classList.add('active');
            statusText.textContent = "üü¢ Î≥¥Ïïà Ïó∞Í≤∞Îê®";
            
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.placeholder = "ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...";
            userInput.focus();
            
            addMessage("ai", "ÏïàÎÖïÌïòÏÑ∏Ïöî. ÏÑ†ÏÉùÎãòÏùò PCÏóêÏÑú ÏûëÎèôÌïòÎäî Î≥¥Ïïà AIÏûÖÎãàÎã§. **ÏïûÏÑ† ÎåÄÌôî ÎÇ¥Ïö©ÏùÑ Í∏∞Ïñµ**ÌïòÎ©∞ Îß§Îâ¥Ïñº Í∏∞Î∞òÏúºÎ°ú ÎãµÎ≥ÄÌïòÍ≤†ÏäµÎãàÎã§.");

        } catch (error) {
            console.error(error);
            addMessage("system", `üö® Ïò§Î•ò Î∞úÏÉù: ${error.message}`);
        }
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        addMessage("user", text);
        userInput.value = "";
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = "ÏÉùÍ∞Å Ï§ë...";

        try {
            // 1. ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏ÏùÑ Í∏∞Ïñµ(History)Ïóê Ï†ÄÏû•
            conversationHistory.push({ role: "user", content: text });

            // 2. ÌîÑÎ°¨ÌîÑÌä∏ Íµ¨ÏÑ± (Îß§Îâ¥Ïñº + ÏµúÍ∑º ÎåÄÌôî ÎÇ¥Ïó≠ 2Í∞úÎßå Ï†ÑÏÜ° - Î©îÎ™®Î¶¨ Ï†àÏïΩ)
            // ÎÑàÎ¨¥ ÎßéÏùÄ ÎåÄÌôîÎ•º ÎÑ£ÏúºÎ©¥ 1B Î™®Îç∏Ïù¥ Ìó∑Í∞àÎ†§ÌïòÎØÄÎ°ú ÏµúÍ∑º 2~3ÌÑ¥Îßå Ïú†ÏßÄ
            const recentHistory = conversationHistory.slice(-4); 

            const messages = [
                { 
                    role: "system", 
                    content: `ÎÑàÎäî ÏïÑÎèôÎ≥¥Ìò∏Ï†ÑÎ¨∏Í∏∞Í¥ÄÏùò Îß§Îâ¥Ïñº AIÎã§. 
                    ÏïÑÎûò [Îß§Îâ¥Ïñº] ÎÇ¥Ïö©ÏùÑ Í∏∞Î∞òÏúºÎ°ú ÌïúÍµ≠Ïñ¥Î°ú ÎãµÎ≥ÄÌï¥.
                    
                    [ÎãµÎ≥Ä Í∑úÏπô]
                    1. ÏßàÎ¨∏Í≥º Í¥ÄÎ†®Îêú ÎÇ¥Ïö©ÏùÑ Îß§Îâ¥ÏñºÏóêÏÑú Ï∞æÏïÑ ÎãµÎ≥ÄÌï¥.
                    2. 'Ïù¥Ï†Ñ ÎåÄÌôî ÎÇ¥Ïö©'ÏùÑ Ï∞∏Í≥†Ìï¥ÏÑú Îß•ÎùΩÏùÑ Ïù¥Ïñ¥Í∞Ä. (Ïòà: 'Í∑∏Í≤É'Ïù¥ÎùºÍ≥† Î¨ºÏúºÎ©¥ ÏïûÏùò Ï£ºÏ†úÎ•º ÎßêÌïòÎäî Í≤ÉÏûÑ)
                    3. ÎòëÍ∞ôÏùÄ Î¨∏Ïû•ÏùÑ Î∞òÎ≥µÌïòÏßÄ Îßà.
                    4. Îß§Îâ¥ÏñºÏóê ÏóÜÎäî ÎÇ¥Ïö©ÏùÄ Î™®Î•∏Îã§Í≥† Ìï¥.` 
                },
                { 
                    role: "user", 
                    content: `### Îß§Îâ¥Ïñº Îç∞Ïù¥ÌÑ∞ ###\n${manualContent.substring(0, 20000)}` 
                },
                ...recentHistory // [Ï§ëÏöî] Ïó¨Í∏∞Ïóê Ïù¥Ï†Ñ ÎåÄÌôî Í∏∞Î°ùÏù¥ Îì§Ïñ¥Í∞ê
            ];

            let fullResponse = "";
            const chunks = await engine.chat.completions.create({
                messages,
                temperature: 0.1, 
                repetition_penalty: 1.2, // [Ï§ëÏöî] ÏïµÎ¨¥ÏÉà Î∞©ÏßÄ (Í∞ôÏùÄ Îßê Î∞òÎ≥µ Í∏àÏßÄ)
                stream: true,
            });

            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai';
            chatBox.appendChild(aiDiv);

            for await (const chunk of chunks) {
                const content = chunk.choices[0]?.delta?.content || "";
                fullResponse += content;
                aiDiv.innerHTML = marked.parse(fullResponse);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // 3. AI ÎãµÎ≥ÄÎèÑ Í∏∞Ïñµ(History)Ïóê Ï†ÄÏû•
            conversationHistory.push({ role: "assistant", content: fullResponse });

        } catch (error) {
            addMessage("system", "Ïò§Î•ò: " + error.message);
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = "Ï†ÑÏÜ°";
            userInput.focus();
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    initialize();
</script>

</body>
</html>
