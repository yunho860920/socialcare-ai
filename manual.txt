<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialCare AI - Í∏∞Í≥ÑÏ†Å Ìå©Ìä∏ Ï∂îÏ∂ú</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg-color: #121212; --chat-bg: #1e1e1e; --input-bg: #2d2d2d; --accent-color: #0052cc; --text-color: #e0e0e0; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; line-height: 1.6; }
        header { padding: 15px 20px; background: var(--chat-bg); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .title { font-weight: 700; font-size: 1.1rem; color: #fff; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 12px; max-width: 85%; word-break: break-word; font-size: 0.95rem; }
        .ai { background: #2d2d2d; border-left: 3px solid #4facfe; }
        .user { background: var(--accent-color); color: white; align-self: flex-end; }
        .system { background: #263238; color: #b0bec5; text-align: center; align-self: center; font-size: 0.85rem; padding: 8px 15px; border-radius: 20px; }
        #input-area { padding: 20px; background: var(--chat-bg); border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #444; background: var(--input-bg); color: white; outline: none; }
        button { padding: 0 25px; border-radius: 10px; border: none; background: var(--accent-color); color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
<header><div class="title">üõ°Ô∏è Îß§Îâ¥Ïñº Ï†ïÎ∞Ä Í≤ÄÏÉâÍ∏∞ (Temp 0)</div></header>
<div id="chat-box"></div>
<div id="input-area">
    <input type="text" id="user-input" placeholder="Îß§Îâ¥Ïñº Î°úÎî© Ï§ë..." disabled>
    <button id="btn-send" disabled>Ï†ÑÏÜ°</button>
</div>

<script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";
    
    // Î°úÏª¨ Î™®Îç∏ (Llama 3.2 1B)
    const SELECTED_MODEL = "Llama-3.2-1B-Instruct-q4f16_1-MLC";
    
    let engine = null;
    let manualContent = "";
    // 1B Î™®Îç∏Ïùò ÌòºÎûÄÏùÑ ÎßâÍ∏∞ ÏúÑÌï¥ ÌûàÏä§ÌÜ†Î¶¨Îäî 'ÏµúÍ∑º 1Í∞ú'Îßå Í∏∞ÏñµÌïòÍ±∞ÎÇò ÏïÑÏòà Î∫çÎãàÎã§.
    // Ïó¨Í∏∞ÏÑúÎäî Îß•ÎùΩ Ïú†ÏßÄÎ•º ÏúÑÌï¥ 'ÏßÅÏ†Ñ ÎåÄÌôî 1ÏÑ∏Ìä∏'Îßå Ïú†ÏßÄÌï©ÎãàÎã§.
    let lastConversation = ""; 

    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('btn-send');

    function addMessage(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = type === 'ai' ? marked.parse(text) : text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function initialize() {
        try {
            const res = await fetch('manual.txt?v=' + Date.now());
            manualContent = await res.text();
            
            addMessage("system", "üöÄ AI ÏóîÏßÑ ÏãúÎèô Ï§ë...");
            engine = await CreateMLCEngine(SELECTED_MODEL, { 
                initProgressCallback: (p) => { 
                    if(p.progress === 1) addMessage("system", "‚úÖ Ï§ÄÎπÑ ÏôÑÎ£å (Ï†ïÎ∞Ä Î™®Îìú)"); 
                } 
            });
            userInput.disabled = false; sendBtn.disabled = false;
            userInput.placeholder = "ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...";
            userInput.focus();
        } catch (e) { addMessage("system", "üö® Ïò§Î•ò Î∞úÏÉù"); }
    }

    async function sendMessage() {
        const text = userInput.value.trim(); if (!text) return;
        addMessage("user", text); userInput.value = "";
        
        // [ÏàòÏ†ï] ÌîÑÎ°¨ÌîÑÌä∏Î•º ÏïÑÏ£º Îã®ÏàúÌïòÍ≤å Î≥ÄÍ≤Ω (AIÍ∞Ä Ìó∑Í∞àÎ¶¨ÏßÄ ÏïäÍ≤å)
        // Î≥µÏû°Ìïú JSON Íµ¨Ï°∞ ÎåÄÏã†, 1B Î™®Îç∏Ïù¥ Ïù¥Ìï¥ÌïòÍ∏∞ Ïâ¨Ïö¥ ÌÖçÏä§Ìä∏ Íµ¨Ï°∞Î°ú Î≥¥ÎÉÑ
        const promptMessages = [
            { 
                role: "system", 
                content: "ÏßÄÏπ®: ÎÑàÎäî Îß§Îâ¥Ïñº Í≤ÄÏÉâ Î¥áÏù¥Îã§. ÏïÑÎûò [Îß§Îâ¥Ïñº] ÎÇ¥Ïö©ÏóêÏÑú ÏßàÎ¨∏Ïóê ÎåÄÌïú ÎãµÏùÑ Ï∞æÏïÑ ÌïúÍµ≠Ïñ¥Î°ú ÎãµÎ≥ÄÌï¥Îùº. ÏÉùÍ∞ÅÏù¥ÎÇò Ìï¥ÏÑùÏùÑ ÎçßÎ∂ôÏù¥ÏßÄ ÎßàÎùº." 
            },
            { 
                role: "user", 
                content: `
[Îß§Îâ¥Ïñº Îç∞Ïù¥ÌÑ∞ ÏãúÏûë]
${manualContent.substring(0, 15000)}
[Îß§Îâ¥Ïñº Îç∞Ïù¥ÌÑ∞ ÎÅù]

[Ïù¥Ï†Ñ ÎåÄÌôî Îß•ÎùΩ]
${lastConversation}

[ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏]
${text}

[ÎãµÎ≥Ä]
` 
            }
        ];

        try {
            let fullResponse = "";
            const chunks = await engine.chat.completions.create({
                messages: promptMessages,
                temperature: 0.0, // [ÏöîÏ≤≠ÌïòÏã† ÏÑ§Ï†ï] Î¨¥Ï°∞Í±¥ 0ÏúºÎ°ú Í≥†Ï†ï
                repetition_penalty: 1.2, // ÎáåÏ†ïÏßÄ(Î¨¥ÌïúÎ∞òÎ≥µ) Î∞©ÏßÄÏö© ÏïàÏ†ÑÏû•Ïπò
                stream: true
            });

            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai';
            chatBox.appendChild(aiDiv);

            for await (const chunk of chunks) {
                fullResponse += chunk.choices[0]?.delta?.content || "";
                aiDiv.innerHTML = marked.parse(fullResponse);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
            
            // ÏßÅÏ†Ñ ÎåÄÌôîÎßå Í∏∞Ïñµ (ÎÑàÎ¨¥ ÎßéÏù¥ Í∏∞ÏñµÌïòÎ©¥ 1B Î™®Îç∏ÏùÄ Íº¨ÏûÑ)
            lastConversation = `Q: ${text}\nA: ${fullResponse}`;

        } catch (e) { addMessage("system", "ÎãµÎ≥Ä Ïã§Ìå®"); }
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    initialize();
</script>
</body>
</html>
