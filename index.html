<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë‰´ì–¼ ì •ë°€ ê²€ì¦ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg-color: #121212; --chat-bg: #1e1e1e; --input-bg: #2d2d2d; --accent-color: #0052cc; --text-color: #e0e0e0; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; line-height: 1.6; }
        
        header { padding: 15px 20px; background: var(--chat-bg); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .title { font-weight: 700; font-size: 1.1rem; color: #fff; }
        .debug-btn { font-size: 0.8rem; padding: 5px 10px; background: #444; color: #fff; border: 1px solid #666; border-radius: 5px; cursor: pointer; }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 12px; max-width: 85%; word-break: break-word; font-size: 0.95rem; }
        .ai { background: #2d2d2d; border-left: 3px solid #4facfe; }
        .user { background: var(--accent-color); color: white; align-self: flex-end; }
        .system { background: #263238; color: #b0bec5; text-align: center; font-size: 0.85rem; padding: 8px 15px; border-radius: 20px; align-self: center; }
        
        #input-area { padding: 20px; background: var(--chat-bg); border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #444; background: var(--input-bg); color: white; outline: none; }
        button { padding: 0 25px; border-radius: 10px; border: none; background: var(--accent-color); color: white; font-weight: bold; cursor: pointer; }
        
        #debug-panel { display: none; padding: 15px; background: #333; color: #0f0; font-family: monospace; font-size: 12px; height: 150px; overflow: auto; border-bottom: 1px solid #555; }
    </style>
</head>
<body>

<header>
    <div class="title">ğŸ” ë§¤ë‰´ì–¼ ê²€ì¦ ì±—ë´‡</div>
    <button class="debug-btn" onclick="toggleDebug()">ğŸ’¾ ë§¤ë‰´ì–¼ ë¡œë“œ í™•ì¸</button>
</header>

<div id="debug-panel" id="debug-text">ë§¤ë‰´ì–¼ íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>

<div id="chat-box"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="ì‹œìŠ¤í…œ ë¡œë”© ì¤‘..." disabled>
    <button id="btn-send" disabled>ì „ì†¡</button>
</div>

<script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";
    const SELECTED_MODEL = "Llama-3.2-1B-Instruct-q4f16_1-MLC";
    
    let engine = null;
    let manualContent = "";
    const debugPanel = document.getElementById('debug-panel');

    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('btn-send');

    // ë””ë²„ê·¸ íŒ¨ë„ í† ê¸€ í•¨ìˆ˜
    window.toggleDebug = () => {
        debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
    };

    function addMessage(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = type === 'ai' ? marked.parse(text) : text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function initialize() {
        try {
            // 1. ë§¤ë‰´ì–¼ ë¡œë“œ í™•ì¸
            addMessage("system", "ğŸ“‚ manual.txt ì½ëŠ” ì¤‘...");
            const res = await fetch('manual.txt?v=' + Date.now());
            if (!res.ok) throw new Error("manual.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            
            manualContent = await res.text();
            
            // [ì¤‘ìš”] ë””ë²„ê·¸ íŒ¨ë„ì— ë§¤ë‰´ì–¼ ì•ë¶€ë¶„ì„ ë³´ì—¬ì¤Œ (ë¡œë“œ ì„±ê³µ ì—¬ë¶€ ì‹œê°í™”)
            debugPanel.innerText = "âœ… ë¡œë“œ ì„±ê³µ! (ì•ë¶€ë¶„ 500ì ë¯¸ë¦¬ë³´ê¸°):\n\n" + manualContent.substring(0, 500) + "...";
            addMessage("system", "âœ… ë§¤ë‰´ì–¼ ë¡œë“œ ì„±ê³µ (ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼ìœ¼ë¡œ ë‚´ìš© í™•ì¸ ê°€ëŠ¥)");

            // 2. ì—”ì§„ ì‹œë™
            addMessage("system", "ğŸš€ AI ì—”ì§„ ì‹œë™ ì¤‘...");
            engine = await CreateMLCEngine(SELECTED_MODEL, { 
                initProgressCallback: (p) => { 
                    if(p.progress === 1) {
                        addMessage("system", "âœ… ì¤€ë¹„ ì™„ë£Œ."); 
                        userInput.disabled = false; sendBtn.disabled = false;
                        userInput.placeholder = "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...";
                        userInput.focus();
                    }
                } 
            });

        } catch (e) { 
            addMessage("system", "ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜: " + e.message); 
            debugPanel.innerText = "ì˜¤ë¥˜ ë°œìƒ: " + e.message;
        }
    }

    async function sendMessage() {
        const text = userInput.value.trim(); if (!text) return;
        addMessage("user", text); userInput.value = "";
        
        // [ë§¤ë‰´ì–¼ ê°•ì œ ì£¼ì… ì „ëµ]
        // 1B ëª¨ë¸ì˜ ìš©ëŸ‰ í•œê³„(Context Window)ë¥¼ ê³ ë ¤í•˜ì—¬ 8,000ìë¡œ ì œí•œ
        // ì§ˆë¬¸ ë°”ë¡œ ìœ„ì— ë§¤ë‰´ì–¼ì„ ë°°ì¹˜í•˜ì—¬ 'ì»¨ë‹'í•˜ê¸° ì‰½ê²Œ ë§Œë“¦
        const limitedManual = manualContent.substring(0, 8000); 

        const messages = [
            { 
                role: "user", 
                content: `
[ì ˆëŒ€ ê·œì¹™]
ë„ˆëŠ” ì•„ë˜ ì œê³µëœ 'ì°¸ê³  í…ìŠ¤íŠ¸'ì˜ ë‚´ìš©ë§Œ ê°€ì§€ê³  ëŒ€ë‹µí•´ì•¼ í•œë‹¤.
ë„¤ê°€ ì›ë˜ ì•Œê³  ìˆë˜ ì§€ì‹ì€ ëª¨ë‘ ìŠì–´ë¼.
'ì°¸ê³  í…ìŠ¤íŠ¸'ì— ì—†ëŠ” ë‚´ìš©ì€ "ë§¤ë‰´ì–¼ì— ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ë‹µí•´ë¼.

[ì°¸ê³  í…ìŠ¤íŠ¸ ì‹œì‘]
${limitedManual}
[ì°¸ê³  í…ìŠ¤íŠ¸ ë]

[ì§ˆë¬¸]
${text}

[ë‹µë³€]
` 
            }
        ];

        try {
            let fullResponse = "";
            const chunks = await engine.chat.completions.create({
                messages: messages,
                temperature: 0.0, // ìƒìƒë ¥ ì™„ì „ ì°¨ë‹¨
                repetition_penalty: 1.2, // ë°˜ë³µ ë°©ì§€
                stream: true
            });

            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai';
            chatBox.appendChild(aiDiv);

            for await (const chunk of chunks) {
                fullResponse += chunk.choices[0]?.delta?.content || "";
                aiDiv.innerHTML = marked.parse(fullResponse);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

        } catch (e) { addMessage("system", "ë‹µë³€ ì‹¤íŒ¨"); }
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    initialize();
</script>
</body>
</html>
