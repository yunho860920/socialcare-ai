<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialCare AI - ìµœì¢… ì§„ë‹¨ ë„êµ¬</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        .header { padding: 20px; background: #1e1e1e; border-bottom: 1px solid #333; text-align: center; }
        .container { flex: 1; display: flex; flex-direction: column; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        /* ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ */
        #chat-box { flex: 1; overflow-y: auto; border: 1px solid #333; background: #1e1e1e; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 8px; max-width: 80%; line-height: 1.5; }
        .ai { background: #2d2d2d; color: #e0e0e0; align-self: flex-start; border-left: 4px solid #4facfe; }
        .user { background: #0052cc; color: white; align-self: flex-end; margin-left: auto; }
        .system { background: #2b1d00; color: #ffd54f; border: 1px solid #5f4b00; text-align: center; width: 100%; box-sizing: border-box; }
        .error { background: #3d0000; color: #ff8a80; border: 1px solid #8a0000; }

        /* ì…ë ¥ ì˜ì—­ */
        .controls { display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 8px; border: 1px solid #333; background: #2d2d2d; color: white; font-size: 16px; }
        button { padding: 15px 25px; border-radius: 8px; border: none; background: #0052cc; color: white; font-weight: bold; cursor: pointer; }
        button:hover { background: #0065ff; }
        button:disabled { background: #444; cursor: not-allowed; }

        /* ëª¨ë¸ ì„ íƒ ë²„íŠ¼ */
        .model-btn { display: inline-block; margin: 5px; padding: 8px 12px; background: #333; border: 1px solid #555; border-radius: 20px; cursor: pointer; font-size: 14px; }
        .model-btn:hover { background: #444; border-color: #777; }
        .model-btn.active { background: #0052cc; border-color: #0052cc; }
    </style>
</head>
<body>

<div class="header">
    <h2>ğŸ› ï¸ AI ì—°ê²° ì§„ë‹¨ ë° ì±„íŒ…</h2>
    <div id="status" style="font-size: 14px; color: #aaa;">ìƒíƒœ: ì¤€ë¹„ë¨</div>
</div>

<div class="container">
    <div id="chat-box">
        <div class="message system">
            ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”. ë§ˆì§€ë§‰ í•´ê²°ì±…ì…ë‹ˆë‹¤.<br>
            ì•„ë˜ ì…ë ¥ì°½ì— <b>'ìƒˆ í”„ë¡œì íŠ¸ API í‚¤'</b>ë¥¼ ë„£ê³  ì „ì†¡ì„ ëˆ„ë¥´ì„¸ìš”.<br>
            êµ¬ê¸€ ì„œë²„ì—ì„œ ì§ì ‘ ëª¨ë¸ ëª…ë‹¨ì„ ê°€ì ¸ì˜¤ê² ìŠµë‹ˆë‹¤.
        </div>
    </div>

    <div class="controls">
        <input type="text" id="user-input" placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë˜ëŠ” ì§ˆë¬¸ ì…ë ¥)" autofocus>
        <button id="btn-send">í™•ì¸</button>
    </div>
</div>

<script>
    // ìƒíƒœ ë³€ìˆ˜
    let API_KEY = localStorage.getItem("DIAGNOSTIC_KEY");
    let SELECTED_MODEL = "";
    let STEP = API_KEY ? 1 : 0; // 0:í‚¤ì…ë ¥, 1:ëª¨ë¸ì„ íƒ/ì±„íŒ…

    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('user-input');
    const btn = document.getElementById('btn-send');
    const status = document.getElementById('status');

    // ì´ˆê¸°í™”
    if (API_KEY) {
        log("ğŸ”‘ ì €ì¥ëœ í‚¤ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ëª¨ë¸ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤...", "system");
        fetchModels();
    } else {
        input.placeholder = "ìƒˆ í”„ë¡œì íŠ¸ì˜ API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (AIza...)";
    }

    // ì—”í„°í‚¤ ì²˜ë¦¬
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleAction();
    });
    btn.addEventListener('click', handleAction);

    async function handleAction() {
        const text = input.value.trim();
        if (!text) return;

        if (STEP === 0) {
            // í‚¤ ì…ë ¥ ë‹¨ê³„
            API_KEY = text;
            localStorage.setItem("DIAGNOSTIC_KEY", API_KEY);
            input.value = "";
            log("ğŸ” í‚¤ë¥¼ í™•ì¸í•˜ê³  ëª¨ë¸ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤...", "system");
            await fetchModels();
        } else {
            // ì±„íŒ… ë‹¨ê³„
            if (!SELECTED_MODEL) {
                alert("ë¨¼ì € ìœ„ì—ì„œ ì‚¬ìš©í•  ëª¨ë¸ì„ í´ë¦­í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”!");
                return;
            }
            sendMessage(text);
        }
    }

    // 1. ëª¨ë¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ListModels) - ì´ê²Œ í•µì‹¬ì…ë‹ˆë‹¤!
    async function fetchModels() {
        status.innerText = "ìƒíƒœ: ëª¨ë¸ ê²€ìƒ‰ ì¤‘...";
        try {
            // êµ¬ê¸€ì—ê²Œ "ë‚´ í‚¤ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ëª¨ë¸ ë‹¤ ë‚´ë†”" ë¼ê³  ìš”ì²­
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error?.message || "í‚¤ ì˜¤ë¥˜");
            }

            // ì±„íŒ… ê°€ëŠ¥í•œ ëª¨ë¸ë§Œ í•„í„°ë§
            const validModels = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
            
            if (validModels.length === 0) {
                throw new Error("ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
            }

            log(`âœ… ì—°ê²° ì„±ê³µ! ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ${validModels.length}ê°œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”:`, "ai");
            
            // ëª¨ë¸ ë²„íŠ¼ ìƒì„±
            const btnContainer = document.createElement('div');
            btnContainer.className = "message ai";
            validModels.forEach(m => {
                // 'models/gemini-pro' -> 'gemini-pro'ë¡œ ì´ë¦„ë§Œ ì¶”ì¶œ
                const shortName = m.name.replace("models/", "");
                const b = document.createElement('span');
                b.className = "model-btn";
                b.innerText = shortName;
                b.onclick = () => selectModel(shortName, b);
                btnContainer.appendChild(b);
            });
            chatBox.appendChild(btnContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            STEP = 1;
            input.placeholder = "ì´ì œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì•ˆë…•?)";
            status.innerText = "ìƒíƒœ: ëª¨ë¸ ì„ íƒ ëŒ€ê¸°";

        } catch (e) {
            log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${e.message}<br>íŒ: í‚¤ê°€ ì •í™•í•œì§€, 'ìƒˆ í”„ë¡œì íŠ¸' í‚¤ê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`, "error");
            localStorage.removeItem("DIAGNOSTIC_KEY");
            STEP = 0;
            input.placeholder = "API í‚¤ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”";
        }
    }

    // 2. ëª¨ë¸ ì„ íƒ
    function selectModel(modelName, btnElement) {
        SELECTED_MODEL = modelName;
        document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        log(`ğŸ‘Œ <b>${modelName}</b> ëª¨ë¸ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ì§ˆë¬¸í•´ ì£¼ì„¸ìš”!`, "system");
        status.innerText = `ìƒíƒœ: ${modelName} ì—°ê²°ë¨`;
    }

    // 3. ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage(text) {
        input.value = "";
        log(text, "user");
        const loadingDiv = log("...", "ai");

        try {
            // ì„ íƒëœ 'ì •í™•í•œ ì´ë¦„'ìœ¼ë¡œ ìš”ì²­
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${SELECTED_MODEL}:generateContent?key=${API_KEY}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: text }] }]
                })
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.error?.message);

            if (data.candidates && data.candidates[0].content) {
                loadingDiv.innerHTML = data.candidates[0].content.parts[0].text;
            } else {
                loadingDiv.innerText = "ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.";
            }
        } catch (e) {
            loadingDiv.className = "message error";
            loadingDiv.innerText = "ì˜¤ë¥˜: " + e.message;
        }
    }

    function log(html, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = html;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }
</script>

</body>
</html>
