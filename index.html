<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒë‹´ ë§¤ë‰´ì–¼ ë¹„ì„œ (í•µì‹¬ ìš”ì•½ ë²„ì „)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; line-height: 1.6; }
        header { padding: 15px 20px; background: #1e1e1e; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .title { font-weight: bold; font-size: 1.1rem; }
        #api-key-input { padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; width: 150px; }
        button { padding: 8px 15px; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #444; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .message { padding: 12px 18px; border-radius: 12px; max-width: 85%; }
        .ai { background: #2d2d2d; border-left: 3px solid #4facfe; }
        .user { background: #0052cc; align-self: flex-end; color: white; }
        .system { background: #333; color: #aaa; align-self: center; font-size: 0.85rem; padding: 5px 12px; border-radius: 15px; }
        .error { background: #b71c1c; color: #ffcdd2; text-align: center; }
        
        /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .ai strong { color: #64b5f6; }
        .ai ul, .ai ol { padding-left: 20px; margin: 5px 0; }
        .ai h1, .ai h2, .ai h3 { font-size: 1.1em; margin: 10px 0 5px; color: #fff; }

        #input-area { padding: 20px; border-top: 1px solid #333; display: flex; gap: 10px; background: #1e1e1e; }
        input[type="text"] { flex: 1; padding: 15px; background: #2d2d2d; border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; outline: none; }
    </style>
</head>
<body>

<header>
    <div class="title">ğŸ¤– ìƒë‹´ ë§¤ë‰´ì–¼ ë¹„ì„œ (Core)</div>
    <div>
        <input type="password" id="api-key-input" placeholder="API Key ì…ë ¥">
        <button id="btn-save">í‚¤ ì €ì¥</button>
    </div>
</header>

<div id="chat-box"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="í‚¤ ì €ì¥ í›„ ì‚¬ìš© ê°€ëŠ¥" disabled>
    <button id="btn-send" disabled>ì „ì†¡</button>
</div>

<script>
    let apiKey = localStorage.getItem("GEMINI_API_KEY");
    let manualContent = "";
    
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('btn-send');
    const keyInput = document.getElementById('api-key-input');

    // 1. ì‹œì‘ ì‹œ
    if (apiKey) {
        keyInput.value = apiKey;
        loadManual();
    } else {
        addMsg("system", "ìš°ì¸¡ ìƒë‹¨ì— API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");
    }

    // 2. í‚¤ ì €ì¥
    document.getElementById('btn-save').onclick = () => {
        const key = keyInput.value.trim();
        if(!key) return alert("í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        apiKey = key;
        localStorage.setItem("GEMINI_API_KEY", key);
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadManual();
    };

    // 3. ë§¤ë‰´ì–¼ ë¡œë“œ
    async function loadManual() {
        try {
            const res = await fetch('manual.txt?v=' + Date.now());
            if(!res.ok) throw new Error("íŒŒì¼ ì—†ìŒ");
            manualContent = await res.text();
            addMsg("system", "âœ… ë§¤ë‰´ì–¼ ì¤€ë¹„ ì™„ë£Œ. ì§ˆë¬¸í•˜ì„¸ìš”.");
            userInput.disabled = false;
            sendBtn.disabled = false;
        } catch (e) {
            addMsg("error", "ğŸš¨ manual.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // 4. ì „ì†¡ (í•µì‹¬: í”„ë¡¬í”„íŠ¸ íŠœë‹)
    async function sendMessage() {
        const text = userInput.value.trim();
        if(!text) return;

        addMsg("user", text);
        userInput.value = "";
        userInput.disabled = true;
        sendBtn.innerText = "...";

        try {
            // [ì„±ê³µí•œ ì„¤ì • ìœ ì§€] v1 ì£¼ì†Œ + gemini-pro ëª¨ë¸
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            // â˜…â˜…â˜… ì—¬ê¸°ê°€ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ì…ë‹ˆë‹¤ â˜…â˜…â˜…
                            text: `
### ì—­í•  ###
ë„ˆëŠ” ì•„ë™ë³´í˜¸ì „ë¬¸ê¸°ê´€ì˜ 'í•µì‹¬ ìš”ì•½' ì „ë¬¸ AI ë¹„ì„œì•¼.
ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ì•„ë˜ [ë§¤ë‰´ì–¼]ì—ì„œ **ì •í™•íˆ ê´€ë ¨ëœ ë‚´ìš©ë§Œ** ì°¾ì•„ì„œ ë‹µë³€í•´.

### ë‹µë³€ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”) ###
1. **ê³¼ë„í•œ ì •ë³´ ê¸ˆì§€**: ì‚¬ìš©ìê°€ ë¬»ì§€ ì•Šì€ ë°°ê²½ ì§€ì‹, ë²•ì  ê·¼ê±°, ë‹¤ë¥¸ ìœ í˜• ë“±ì€ ì ˆëŒ€ ë¨¼ì € ë§í•˜ì§€ ë§ˆ.
2. **í•µì‹¬ë§Œ ì „ë‹¬**: ì§ˆë¬¸ì— ëŒ€í•œ ì •ë‹µë§Œ 3~5ì¤„ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´.
3. **ë§¤ë‰´ì–¼ ì¤€ìˆ˜**: ë§¤ë‰´ì–¼ì— ì—†ëŠ” ë‚´ìš©ì€ ì§€ì–´ë‚´ì§€ ë§ê³  "ë§¤ë‰´ì–¼ì— ì—†ìŠµë‹ˆë‹¤"ë¼ê³  í•´.

### ë§¤ë‰´ì–¼ ë°ì´í„° ###
${manualContent.substring(0, 25000)}

### ì‚¬ìš©ì ì§ˆë¬¸ ###
"${text}"

### ë‹µë³€ ###
`
                        }]
                    }]
                })
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error?.message || "API í˜¸ì¶œ ì‹¤íŒ¨");
            }

            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "ë‹µë³€ ë¶ˆê°€";
            addMsg("ai", aiText);

        } catch (e) {
            addMsg("error", `ì˜¤ë¥˜: ${e.message}`);
        } finally {
            userInput.disabled = false;
            sendBtn.innerText = "ì „ì†¡";
            userInput.focus();
        }
    }

    function addMsg(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = type === 'ai' ? marked.parse(text) : text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { if(e.key==='Enter') sendMessage(); }
</script>
</body>
</html>
