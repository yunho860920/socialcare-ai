<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialCare AI - í†µí•© ì™„ì„±ë³¸</title>
    <style>
        /* ê¹”ë”í•œ ë‹¤í¬ëª¨ë“œ ë””ìì¸ */
        body { font-family: sans-serif; background: #121212; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { padding: 15px; background: #1e1e1e; border-bottom: 1px solid #333; text-align: center; font-weight: bold; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 12px; max-width: 80%; line-height: 1.5; word-break: break-word; }
        .ai { background: #2d2d2d; color: #e0e0e0; align-self: flex-start; border-left: 4px solid #4facfe; }
        .user { background: #0052cc; color: white; align-self: flex-end; }
        .error { background: #3d0000; color: #ff8a80; border: 1px solid #8a0000; text-align: center; width: 100%; box-sizing: border-box; }
        
        /* ì…ë ¥ì°½ ì˜ì—­ */
        #input-area { padding: 20px; background: #1e1e1e; border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 8px; border: 1px solid #444; background: #2d2d2d; color: white; font-size: 16px; outline: none; }
        input:focus { border-color: #0052cc; }
        button { padding: 0 25px; border-radius: 8px; border: none; background: #0052cc; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #0065ff; }
        button:disabled { background: #444; cursor: not-allowed; }
    </style>
</head>
<body>

<header>
    ğŸŸ¢ SocialCare AI (ê³µì‹ SDK ì—°ê²°ë¨)
</header>

<div id="chat-container">
    <div class="message ai">
        ì•ˆë…•í•˜ì„¸ìš”. ë“œë””ì–´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰<br>
        ì´ì œ ëŠê¹€ ì—†ì´ ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        (ë°©ê¸ˆ í™•ì¸í•˜ì‹  'ìƒˆ í”„ë¡œì íŠ¸ í‚¤'ë¥¼ ì¤€ë¹„í•´ì£¼ì„¸ìš”.)
    </div>
</div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autofocus>
    <button id="btn-send">ì „ì†¡</button>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const chatBox = document.getElementById('chat-container');
    const input = document.getElementById('user-input');
    const btn = document.getElementById('btn-send');

    // 1. í‚¤ ê´€ë¦¬ (ì €ì¥ì†Œ ì´ë¦„ ë³€ê²½ìœ¼ë¡œ ìƒˆ í‚¤ ê°•ì œ ì…ë ¥ ìœ ë„)
    const STORAGE_KEY = "FINAL_VICTORY_KEY";
    let apiKey = localStorage.getItem(STORAGE_KEY);

    // 2. ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = text; // HTML íƒœê·¸ í—ˆìš©
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }

    // 3. í‚¤ê°€ ì—†ìœ¼ë©´ ë¬¼ì–´ë³´ê¸°
    if (!apiKey) {
        addMessage("ğŸ”‘ <b>API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</b><br>ì•„ë˜ ì…ë ¥ì°½ì— 'ìƒˆ í”„ë¡œì íŠ¸ í‚¤'ë¥¼ ë„£ê³  ì „ì†¡ì„ ëˆ„ë¥´ì„¸ìš”.", "system error");
    }

    // 4. ì „ì†¡ ë¡œì§
    async function handleSend() {
        const text = input.value.trim();
        if (!text) return;

        // í‚¤ ì…ë ¥ ëª¨ë“œì¸ì§€ í™•ì¸
        if (!apiKey) {
            if (text.startsWith("AIza")) {
                apiKey = text;
                localStorage.setItem(STORAGE_KEY, apiKey);
                input.value = "";
                addMessage("âœ… í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ì§ˆë¬¸í•˜ì„¸ìš”!", "ai");
                
                // í™”ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ SDK ì¬ì„¤ì • (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
                setTimeout(() => location.reload(), 1000);
            } else {
                alert("ì˜¬ë°”ë¥¸ API í‚¤(AIza...)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
            return;
        }

        // ì¼ë°˜ ëŒ€í™” ëª¨ë“œ
        input.value = "";
        addMessage(text, "user");
        const loadingMsg = addMessage("ìƒê° ì¤‘...", "ai");
        btn.disabled = true;

        try {
            // [í•µì‹¬] ê³µì‹ ë„êµ¬ ì´ˆê¸°í™”
            const genAI = new GoogleGenerativeAI(apiKey);
            
            // [ì¤‘ìš”] ì•„ê¹Œ ëª©ë¡ì—ì„œ í™•ì¸ëœ ê°€ì¥ ì•ˆì „í•œ ëª¨ë¸ ì‚¬ìš© (1.5 Flash)
            // 2.5 ê°™ì€ ì‹¤í—˜ìš© ëª¨ë¸ì€ ì•„ì§ ì›¹ ì—°ë™ì´ ë¶ˆì•ˆì •í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 1.5ë¡œ ì¡ìŠµë‹ˆë‹¤.
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            const result = await model.generateContent(text);
            const response = await result.response;
            const aiText = response.text();

            loadingMsg.innerText = aiText; // ë‹µë³€ êµì²´

        } catch (error) {
            console.error(error);
            loadingMsg.className = "message error";
            loadingMsg.innerHTML = `â›” ì˜¤ë¥˜: ${error.message}<br>(íŒ: í‚¤ê°€ ì •í™•í•œì§€, ì¸í„°ë„·ì´ ì—°ê²°ëëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”)`;
            
            if (error.message.includes("API key")) {
                localStorage.removeItem(STORAGE_KEY); // í‚¤ê°€ í‹€ë ¸ìœ¼ë©´ ì‚­ì œ
                addMessage("í‚¤ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.", "error");
            }
        } finally {
            btn.disabled = false;
            input.focus();
        }
    }

    // ì´ë²¤íŠ¸ ì—°ê²°
    btn.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleSend();
    });
</script>

</body>
</html>
