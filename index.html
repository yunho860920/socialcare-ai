<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialCare AI - ë§¤ë‰´ì–¼ ë§ˆìŠ¤í„°</title>
    <style>
        /* ë””ìì¸: ê¹”ë”í•œ ë‹¤í¬ ëª¨ë“œ + ê°€ë…ì„± ê°•í™” */
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; background: #121212; color: #e0e0e0; margin: 0; display: flex; flex-direction: column; height: 100vh; line-height: 1.6; }
        header { padding: 15px; background: #1e1e1e; border-bottom: 1px solid #333; text-align: center; font-weight: bold; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; padding-left: 20px; padding-right: 20px;}
        
        /* ë§¤ë‰´ì–¼ ìƒíƒœ í‘œì‹œë“± */
        #manual-status { font-size: 0.8rem; padding: 5px 10px; border-radius: 12px; background: #333; color: #aaa; }
        #manual-status.ok { background: #1b5e20; color: #a5d6a7; border: 1px solid #2e7d32; }
        #manual-status.fail { background: #b71c1c; color: #ffcdd2; border: 1px solid #c62828; }

        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        
        .message { padding: 15px 20px; border-radius: 16px; max-width: 85%; word-break: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .ai { background: #2d2d2d; color: #ececec; align-self: flex-start; border-bottom-left-radius: 4px; border-left: 4px solid #4facfe; }
        .user { background: #0052cc; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .system { background: #263238; color: #b0bec5; font-size: 0.9rem; text-align: center; align-self: center; width: auto; }
        .error { background: #3d0000; color: #ff8a80; border: 1px solid #8a0000; text-align: center; }

        /* í…ìŠ¤íŠ¸ ê¾¸ë¯¸ê¸° (Bold, List ë“±) */
        .message strong { color: #4facfe; font-weight: 700; }
        .message ul { padding-left: 20px; margin: 5px 0; }
        .message li { margin-bottom: 5px; }

        #input-area { padding: 20px; background: #1e1e1e; border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 8px; border: 1px solid #444; background: #2d2d2d; color: white; font-size: 16px; outline: none; transition: 0.2s; }
        input:focus { border-color: #4facfe; }
        button { padding: 0 25px; border-radius: 8px; border: none; background: #0052cc; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        button:hover { background: #0065ff; transform: translateY(-1px); }
        button:disabled { background: #444; cursor: not-allowed; transform: none; }
    </style>
</head>
<body>

<header>
    <span>ğŸ¤– ì•„ë™ë³´í˜¸ ìƒë‹´ ë¹„ì„œ</span>
    <span id="manual-status">ğŸ“‚ ë§¤ë‰´ì–¼ í™•ì¸ ì¤‘...</span>
</header>

<div id="chat-container">
    <div class="message ai">
        ì•ˆë…•í•˜ì„¸ìš”! ì„ ìƒë‹˜ì˜ ì—…ë¬´ ë§¤ë‰´ì–¼ì„ ì™„ë²½í•˜ê²Œ ìˆ™ì§€í–ˆìŠµë‹ˆë‹¤.<br>
        ì´ì œ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì‹œë©´ <b>ë§¤ë‰´ì–¼ì— ê¸°ë°˜í•´ì„œ</b> ì •í™•íˆ ë‹µë³€í•´ ë“œë¦´ê²Œìš”.
    </div>
</div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autofocus>
    <button id="btn-send">ì „ì†¡</button>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const chatBox = document.getElementById('chat-container');
    const input = document.getElementById('user-input');
    const btn = document.getElementById('btn-send');
    const statusLabel = document.getElementById('manual-status');

    // í‚¤ ê´€ë¦¬
    const STORAGE_KEY = "FINAL_VICTORY_KEY";
    let apiKey = localStorage.getItem(STORAGE_KEY);
    let manualContent = "";

    // 1. ë§¤ë‰´ì–¼ íŒŒì¼ ë¡œë“œ (ì‹œì‘í•˜ìë§ˆì ì‹¤í–‰)
    async function loadManual() {
        try {
            const response = await fetch('./manual.txt');
            if (response.ok) {
                manualContent = await response.text();
                statusLabel.innerText = "âœ… ë§¤ë‰´ì–¼ ë¡œë“œë¨";
                statusLabel.className = "ok";
                console.log("ë§¤ë‰´ì–¼ ë¡œë”© ì„±ê³µ (ê¸¸ì´: " + manualContent.length + ")");
            } else {
                throw new Error("íŒŒì¼ ì—†ìŒ");
            }
        } catch (e) {
            statusLabel.innerText = "âš ï¸ ë§¤ë‰´ì–¼ ì—†ìŒ (manual.txt í™•ì¸)";
            statusLabel.className = "fail";
            addMessage("âš ï¸ <b>[ê²½ê³ ]</b> 'manual.txt' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°™ì€ í´ë”ì— íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.", "system");
        }
    }
    loadManual();

    // 2. ë©”ì‹œì§€ í™”ë©´ ì¶œë ¥ ë° ê¾¸ë¯¸ê¸° (Formatter)
    function formatText(text) {
        // **êµµê²Œ** -> <strong>êµµê²Œ</strong>
        let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // * ëª©ë¡ -> <li>ëª©ë¡
        formatted = formatted.replace(/^\* (.*$)/gm, '<li>$1</li>');
        // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
        formatted = formatted.replace(/\n/g, '<br>');
        return formatted;
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = type === 'ai' ? formatText(text) : text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }

    // 3. ì „ì†¡ ë¡œì§
    async function handleSend() {
        const text = input.value.trim();
        if (!text) return;

        // í‚¤ ì…ë ¥ ì²˜ë¦¬
        if (!apiKey) {
            if (text.startsWith("AIza")) {
                apiKey = text;
                localStorage.setItem(STORAGE_KEY, apiKey);
                input.value = "";
                addMessage("í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.", "system");
                setTimeout(() => location.reload(), 500);
            } else {
                alert("ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
            return;
        }

        input.value = "";
        addMessage(text, "user");
        const loadingMsg = addMessage("ë§¤ë‰´ì–¼ ê²€ìƒ‰ ì¤‘...", "ai");
        btn.disabled = true;

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            // [í•µì‹¬] AIì—ê²Œ ì—­í• ì„ ê°•ë ¥í•˜ê²Œ ë¶€ì—¬ (í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§)
            const prompt = `
            ë‹¹ì‹ ì€ 'ì•„ë™ë³´í˜¸ì „ë¬¸ê¸°ê´€ ìƒë‹´ì›'ì„ ìœ„í•œ ì—…ë¬´ ë³´ì¡° AIì…ë‹ˆë‹¤.
            ë°˜ë“œì‹œ ì•„ë˜ [ì—…ë¬´ ë§¤ë‰´ì–¼]ì— ìˆëŠ” ë‚´ìš©ë§Œì„ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•´ì•¼ í•©ë‹ˆë‹¤.
            
            [ê·œì¹™]
            1. ë§¤ë‰´ì–¼ì— ì—†ëŠ” ë‚´ìš©ì€ "ë§¤ë‰´ì–¼ì— í•´ë‹¹ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ì†”ì§í•˜ê²Œ ë§í•˜ì„¸ìš”. ì¶”ì¸¡í•˜ì§€ ë§ˆì„¸ìš”.
            2. ë‹µë³€ì€ í•µì‹¬ë§Œ ìš”ì•½í•´ì„œ, ì½ê¸° í¸í•˜ê²Œ ë²ˆí˜¸ë‚˜ ê°•ì¡°(Bold)ë¥¼ ì¨ì„œ ì •ë¦¬í•˜ì„¸ìš”.
            3. ë§íˆ¬ëŠ” ì •ì¤‘í•˜ê³  ì „ë¬¸ì ì¸ 'í•´ìš”ì²´'ë¥¼ ì“°ì„¸ìš”.

            [ì—…ë¬´ ë§¤ë‰´ì–¼ ë°ì´í„°]
            ${manualContent}

            [ì‚¬ìš©ì ì§ˆë¬¸]
            ${text}
            `;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const aiText = response.text();

            loadingMsg.innerHTML = formatText(aiText);

        } catch (error) {
            loadingMsg.className = "message error";
            loadingMsg.innerHTML = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            if (error.message.includes("API key")) localStorage.removeItem(STORAGE_KEY);
        } finally {
            btn.disabled = false;
            input.focus();
        }
    }

    btn.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });

    // ì‹œì‘ ì‹œ í‚¤ í™•ì¸
    if (!apiKey) addMessage("ğŸ”‘ <b>ìƒˆ í”„ë¡œì íŠ¸ API í‚¤</b>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "system");

</script>
</body>
</html>
