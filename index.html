<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialCare AI - ë§¤ë‰´ì–¼ ë¹„ì„œ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- ìŠ¤íƒ€ì¼ë§ (ë‹¤í¬ëª¨ë“œ) --- */
        :root {
            --bg-color: #121212;
            --chat-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --accent-color: #0052cc;
            --text-color: #e0e0e0;
            --system-msg-color: #b0bec5;
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; line-height: 1.6; }
        
        /* í—¤ë” & API ì„¤ì • ì˜ì—­ */
        header { padding: 15px 20px; background: var(--chat-bg); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .title { font-weight: 700; font-size: 1.1rem; color: #fff; }
        
        #api-key-container { display: flex; gap: 10px; align-items: center; }
        #api-key-input { padding: 8px; border-radius: 5px; border: 1px solid #444; background: #333; color: white; width: 200px; font-size: 0.8rem; }
        #btn-save-key { padding: 8px 15px; border-radius: 5px; background: #2e7d32; color: white; border: none; cursor: pointer; font-size: 0.8rem; }
        
        /* ì±„íŒ… ì˜ì—­ */
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 12px; max-width: 85%; word-break: break-word; font-size: 0.95rem; }
        .system { background: #263238; color: var(--system-msg-color); text-align: center; align-self: center; font-size: 0.85rem; padding: 8px 15px; border-radius: 20px; }
        .ai { background: #2d2d2d; border-left: 3px solid #4facfe; align-self: flex-start; }
        .user { background: var(--accent-color); color: white; align-self: flex-end; }
        
        /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .ai strong { color: #64b5f6; }
        .ai ul, .ai ol { padding-left: 20px; margin: 5px 0; }

        /* ì…ë ¥ ì˜ì—­ */
        #input-area { padding: 20px; background: var(--chat-bg); border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #444; background: var(--input-bg); color: white; font-size: 16px; outline: none; }
        button { padding: 0 25px; border-radius: 10px; border: none; background: var(--accent-color); color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.7; }
        
        .loader { display: inline-block; width: 10px; height: 10px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <div class="title">ğŸ¤– ìƒë‹´ ë§¤ë‰´ì–¼ ë¹„ì„œ</div>
    <div id="api-key-container">
        <input type="password" id="api-key-input" placeholder="Gemini API Key ì…ë ¥">
        <button id="btn-save-key">í‚¤ ì €ì¥</button>
    </div>
</header>

<div id="chat-box"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="API í‚¤ ì…ë ¥ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤" disabled>
    <button id="btn-send" disabled>ì „ì†¡</button>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let userApiKey = "";
    let manualContent = "";
    let isProcessing = false;

    // DOM ìš”ì†Œ
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('btn-send');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveKeyBtn = document.getElementById('btn-save-key');

    // 1. ì´ˆê¸°í™”: ì €ì¥ëœ í‚¤ í™•ì¸ ë° ë§¤ë‰´ì–¼ ë¡œë“œ
    window.addEventListener('DOMContentLoaded', async () => {
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ í‚¤ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜´
        const savedKey = localStorage.getItem("GEMINI_API_KEY");
        if (savedKey) {
            apiKeyInput.value = savedKey;
            userApiKey = savedKey;
            addMessage("system", "ğŸ”‘ ì €ì¥ëœ API í‚¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
            await loadManual(); // í‚¤ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ë§¤ë‰´ì–¼ ë¡œë“œ ì‹œë„
        } else {
            addMessage("system", "âš ï¸ ìš°ì¸¡ ìƒë‹¨ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ê³  'í‚¤ ì €ì¥'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        }
    });

    // 2. í‚¤ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
    saveKeyBtn.addEventListener('click', async () => {
        const key = apiKeyInput.value.trim();
        if (!key) return alert("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        
        userApiKey = key;
        localStorage.setItem("GEMINI_API_KEY", key); // ë¸Œë¼ìš°ì €ì— ì €ì¥
        addMessage("system", "âœ… API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        await loadManual(); // í‚¤ ì €ì¥ í›„ ë§¤ë‰´ì–¼ ë¡œë“œ
    });

    // 3. ë§¤ë‰´ì–¼ ë¡œë“œ í•¨ìˆ˜
    async function loadManual() {
        if (!manualContent) { // ì´ë¯¸ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ
            try {
                addMessage("system", "ğŸ“‚ manual.txt íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
                const response = await fetch('manual.txt?v=' + new Date().getTime());
                if (!response.ok) throw new Error("íŒŒì¼ ì—†ìŒ");
                
                manualContent = await response.text();
                addMessage("system", "âœ… ë§¤ë‰´ì–¼ ë¡œë“œ ì™„ë£Œ! ìƒë‹´ ì¤€ë¹„ ë.");
                addMessage("ai", "ì•ˆë…•í•˜ì„¸ìš”, ì—°í˜¸ ì„ ìƒë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?");
                
                // ì…ë ¥ì°½ í™œì„±í™”
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.placeholder = "ê¶ê¸ˆí•œ ë‚´ìš©ì„ ë¬¼ì–´ë³´ì„¸ìš”";
                userInput.focus();
            } catch (error) {
                console.error(error);
                addMessage("system", "ğŸš¨ ì˜¤ë¥˜: manual.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
    }

    // 4. ë©”ì‹œì§€ ì „ì†¡ (ì œë¯¸ë‚˜ì´ API í˜¸ì¶œ)
    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text || isProcessing) return;
        if (!userApiKey) return alert("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤!");

        addMessage("user", text);
        userInput.value = "";
        isProcessing = true;
        userInput.disabled = true;
        sendBtn.innerHTML = '<span class="loader"></span>';

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `
### ì—­í•  ###
ë„ˆëŠ” ì•„ë™ë³´í˜¸ì „ë¬¸ê¸°ê´€ ì‚¬íšŒë³µì§€ì‚¬ì•¼. ì•„ë˜ [ë§¤ë‰´ì–¼]ì„ ë³´ê³  ì§ˆë¬¸ì— í•œêµ­ì–´ë¡œ ë‹µí•´ì¤˜. ì—†ëŠ” ë‚´ìš©ì€ ëª¨ë¥¸ë‹¤ê³  í•´.

### ë§¤ë‰´ì–¼ ###
${manualContent.substring(0, 30000)}

### ì§ˆë¬¸ ###
${text}
`
                        }]
                    }]
                })
            });

            const data = await response.json();
            const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            addMessage("ai", aiResponse);

        } catch (error) {
            addMessage("system", "âš ï¸ API ì˜¤ë¥˜ ë°œìƒ. í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        } finally {
            isProcessing = false;
            userInput.disabled = false;
            sendBtn.innerHTML = "ì „ì†¡";
            userInput.focus();
        }
    }

    // UI í—¬í¼ í•¨ìˆ˜
    function addMessage(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        if (type === 'ai') div.innerHTML = marked.parse(text);
        else div.textContent = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    sendBtn.addEventListener('click', sendMessage);
</script>

</body>
</html>
