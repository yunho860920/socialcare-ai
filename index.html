<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialCare AI - ë§¤ë‰´ì–¼ ë¹„ì„œ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg-color: #121212; --chat-bg: #1e1e1e; --input-bg: #2d2d2d; --accent-color: #0052cc; --text-color: #e0e0e0; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; line-height: 1.6; }
        
        /* í—¤ë” */
        header { padding: 15px 20px; background: var(--chat-bg); border-bottom: 1px solid #333; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .title { font-weight: 700; font-size: 1.1rem; color: #fff; }
        
        .controls { display: flex; gap: 8px; align-items: center; }
        select#model-select { padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #444; font-size: 0.8rem; cursor: pointer; }
        #api-key-input { padding: 8px; border-radius: 5px; border: 1px solid #444; background: #333; color: white; width: 150px; font-size: 0.8rem; }
        #btn-save-key { padding: 8px 15px; border-radius: 5px; background: #2e7d32; color: white; border: none; cursor: pointer; font-size: 0.8rem; }

        /* ì±„íŒ… ì˜ì—­ */
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 12px; max-width: 85%; word-break: break-word; font-size: 0.95rem; }
        .system { background: #263238; color: #b0bec5; text-align: center; align-self: center; font-size: 0.85rem; padding: 8px 15px; border-radius: 20px; }
        .ai { background: #2d2d2d; border-left: 3px solid #4facfe; align-self: flex-start; }
        .user { background: var(--accent-color); color: white; align-self: flex-end; }
        
        /* ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ê°•í™” */
        .error-msg { background: #b71c1c; color: #ffcdd2; border: 1px solid #ff8a80; padding: 10px; border-radius: 8px; font-size: 0.9rem; margin: 10px 0; }
        .ai strong { color: #64b5f6; }
        .ai ul, .ai ol { padding-left: 20px; margin: 5px 0; }

        #input-area { padding: 20px; background: var(--chat-bg); border-top: 1px solid #333; display: flex; gap: 10px; }
        input#user-input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #444; background: var(--input-bg); color: white; font-size: 16px; outline: none; }
        button#btn-send { padding: 0 25px; border-radius: 10px; border: none; background: var(--accent-color); color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.7; }
        
        .loader { display: inline-block; width: 10px; height: 10px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <div class="title">ğŸ¤– ìƒë‹´ ë§¤ë‰´ì–¼ ë¹„ì„œ</div>
    <div class="controls">
        <select id="model-select">
            <option value="gemini-1.5-flash">âš¡ 1.5 Flash (ê¸°ë³¸)</option>
            <option value="gemini-1.5-flash-latest">ğŸš€ 1.5 Flash (ìµœì‹ )</option>
            <option value="gemini-1.5-pro-latest">ğŸ§  1.5 Pro (ìµœì‹ )</option>
            <option value="gemini-pro">ğŸ¢ 1.0 Pro (êµ¬í˜•/í˜¸í™˜ì„±ìµœê³ )</option>
        </select>
        <input type="password" id="api-key-input" placeholder="ìƒˆ API Key ì…ë ¥">
        <button id="btn-save-key">ì €ì¥</button>
    </div>
</header>

<div id="chat-box"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="API í‚¤ ì €ì¥ í›„ ì‚¬ìš© ê°€ëŠ¥" disabled>
    <button id="btn-send" disabled>ì „ì†¡</button>
</div>

<script>
    let userApiKey = "";
    let manualContent = "";
    let isProcessing = false;

    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('btn-send');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveKeyBtn = document.getElementById('btn-save-key');
    const modelSelect = document.getElementById('model-select');

    // 1. ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', async () => {
        const savedKey = localStorage.getItem("GEMINI_API_KEY");
        if (savedKey) {
            apiKeyInput.value = savedKey;
            userApiKey = savedKey;
            addMessage("system", "ğŸ”‘ ì €ì¥ëœ API í‚¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
            await loadManual(); 
        } else {
            addMessage("system", "âš ï¸ ìƒˆ ê³„ì •ì˜ API í‚¤ë¥¼ ì…ë ¥í•˜ê³  [ì €ì¥]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        }
    });

    // 2. í‚¤ ì €ì¥
    saveKeyBtn.addEventListener('click', async () => {
        const key = apiKeyInput.value.trim();
        if (!key) return alert("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        userApiKey = key;
        localStorage.setItem("GEMINI_API_KEY", key);
        addMessage("system", "âœ… API í‚¤ ì €ì¥ ì™„ë£Œ.");
        await loadManual();
    });

    // 3. ë§¤ë‰´ì–¼ ë¡œë“œ
    async function loadManual() {
        if (!manualContent) {
            try {
                const response = await fetch('manual.txt?v=' + Date.now());
                if (!response.ok) throw new Error("íŒŒì¼ ì—†ìŒ");
                manualContent = await response.text();
                addMessage("system", "âœ… ë§¤ë‰´ì–¼ ë¡œë“œ ì™„ë£Œ! (ëª¨ë¸ì„ ì„ íƒí•˜ê³  ì§ˆë¬¸í•˜ì„¸ìš”)");
                addMessage("ai", "ì•ˆë…•í•˜ì„¸ìš”, ì—°í˜¸ ì„ ìƒë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?");
                
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.placeholder = "ê¶ê¸ˆí•œ ë‚´ìš©ì„ ë¬¼ì–´ë³´ì„¸ìš”...";
                userInput.focus();
            } catch (error) {
                addMessage("error-msg", "ğŸš¨ manual.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
    }

    // 4. ì „ì†¡ (í•µì‹¬ ìˆ˜ì •: API ì£¼ì†Œë¥¼ v1beta -> v1ìœ¼ë¡œ ë³€ê²½)
    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text || isProcessing) return;
        if (!userApiKey) return alert("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.");

        const selectedModel = modelSelect.value; 

        addMessage("user", text);
        userInput.value = "";
        isProcessing = true;
        userInput.disabled = true;
        sendBtn.innerHTML = '<span class="loader"></span>';

        try {
            console.log(`[ìš”ì²­] ëª¨ë¸: ${selectedModel}, ì£¼ì†Œ: v1`);

            // [ìµœì¢… í•´ê²°ì±…] ì£¼ì†Œë¥¼ 'v1beta'ì—ì„œ 'v1'ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
            // v1betaëŠ” ìµœì‹  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš©ì´ë¼ ì¢…ì¢… ëª¨ë¸ì„ ëª» ì°¾ì§€ë§Œ, v1ì€ ì •ì‹ ë²„ì „ì´ë¼ ì•ˆì •ì ì…ë‹ˆë‹¤.
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/${selectedModel}:generateContent?key=${userApiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `
### ì—­í•  ###
ë„ˆëŠ” ì•„ë™ë³´í˜¸ì „ë¬¸ê¸°ê´€ ì‚¬íšŒë³µì§€ì‚¬ì•¼. ì•„ë˜ [ë§¤ë‰´ì–¼]ì„ ë³´ê³  ì§ˆë¬¸ì— í•œêµ­ì–´ë¡œ ë‹µí•´ì¤˜.

### ë§¤ë‰´ì–¼ ###
${manualContent.substring(0, 25000)}

### ì§ˆë¬¸ ###
${text}
`
                        }]
                    }]
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                const errMsg = errData.error?.message || response.statusText;
                
                if (response.status === 404) {
                     // 404ê°€ ëœ¨ë©´ ì¦‰ì‹œ ë‹¤ë¥¸ ëª¨ë¸ì„ ì‹œë„í•˜ë¼ê³  ì•ˆë‚´
                    throw new Error(`[404 ëª¨ë¸ ì—†ìŒ] '${selectedModel}' ëª¨ë¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë“œë¡­ë‹¤ìš´ì—ì„œ '1.0 Pro'ë‚˜ 'ìµœì‹ ' ë²„ì „ì„ ì„ íƒí•´ì„œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.`);
                }
                throw new Error(`[ì˜¤ë¥˜ ${response.status}] ${errMsg}`);
            }

            const data = await response.json();
            const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "ë‹µë³€ ë¶ˆê°€";
            addMessage("ai", aiResponse);

        } catch (error) {
            console.error(error);
            addMessage("error-msg", `âš ï¸ ${error.message}`);
        } finally {
            isProcessing = false;
            userInput.disabled = false;
            sendBtn.innerHTML = "ì „ì†¡";
            userInput.focus();
        }
    }

    function addMessage(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        if (type === 'ai') div.innerHTML = marked.parse(text);
        else div.textContent
