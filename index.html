<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒë‹´ ë§¤ë‰´ì–¼ ë¹„ì„œ (ì•ˆì •í™” ë²„ì „)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        header { padding: 15px; background: #1e1e1e; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #api-key-input { padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; width: 200px; }
        button { padding: 8px 15px; background: #0052cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #444; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px; border-radius: 8px; max-width: 80%; }
        .ai { background: #2d2d2d; border-left: 3px solid #4facfe; }
        .user { background: #0052cc; align-self: flex-end; }
        .system { background: #333; color: #aaa; align-self: center; font-size: 0.9em; }
        .error { background: #b71c1c; color: #ffcdd2; text-align: center; }
        #input-area { padding: 20px; border-top: 1px solid #333; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 15px; background: #2d2d2d; border: 1px solid #444; color: white; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <strong>ğŸ¤– ë§¤ë‰´ì–¼ ë¹„ì„œ (v1 Stable)</strong>
    <div>
        <input type="password" id="api-key-input" placeholder="API Key ì…ë ¥">
        <button id="btn-save">í‚¤ ì €ì¥</button>
    </div>
</header>

<div id="chat-box"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="í‚¤ ì €ì¥ í›„ ì‚¬ìš© ê°€ëŠ¥" disabled>
    <button id="btn-send" disabled>ì „ì†¡</button>
</div>

<script>
    let apiKey = localStorage.getItem("GEMINI_API_KEY");
    let manualContent = "";
    
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('btn-send');
    const keyInput = document.getElementById('api-key-input');

    // 1. ì‹œì‘ ì‹œ í‚¤ í™•ì¸ ë° ë§¤ë‰´ì–¼ ë¡œë“œ
    if (apiKey) {
        keyInput.value = apiKey;
        loadManual();
    } else {
        addMsg("system", "ìš°ì¸¡ ìƒë‹¨ì— API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");
    }

    // 2. í‚¤ ì €ì¥
    document.getElementById('btn-save').onclick = () => {
        const key = keyInput.value.trim();
        if(!key) return alert("í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        apiKey = key;
        localStorage.setItem("GEMINI_API_KEY", key);
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadManual();
    };

    // 3. ë§¤ë‰´ì–¼ ë¡œë“œ
    async function loadManual() {
        try {
            const res = await fetch('manual.txt?v=' + Date.now());
            if(!res.ok) throw new Error("manual.txt íŒŒì¼ ì—†ìŒ");
            manualContent = await res.text();
            addMsg("system", "âœ… ë§¤ë‰´ì–¼ ë¡œë“œ ì™„ë£Œ. ì§ˆë¬¸í•˜ì„¸ìš”.");
            userInput.disabled = false;
            sendBtn.disabled = false;
        } catch (e) {
            addMsg("error", "ğŸš¨ manual.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // 4. ì „ì†¡ (í•µì‹¬: v1 ì£¼ì†Œ ì‚¬ìš©)
    async function sendMessage() {
        const text = userInput.value.trim();
        if(!text) return;

        addMsg("user", text);
        userInput.value = "";
        userInput.disabled = true;
        sendBtn.innerText = "...";

        try {
            // [ì¤‘ìš”] ì£¼ì†Œê°€ 'v1beta'ê°€ ì•„ë‹ˆë¼ 'v1' ì…ë‹ˆë‹¤. ëª¨ë¸ì€ 'gemini-pro' ì…ë‹ˆë‹¤.
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `[ë§¤ë‰´ì–¼]\n${manualContent.substring(0,20000)}\n\n[ì§ˆë¬¸]\n${text}\n\n[ì§€ì‹œ]\në§¤ë‰´ì–¼ì— ê¸°ë°˜í•´ì„œ í•œêµ­ì–´ë¡œ ë‹µë³€í•´.`
                        }]
                    }]
                })
            });

            const data = await response.json();
            
            if (!response.ok) {
                console.error(data);
                throw new Error(data.error?.message || "API í˜¸ì¶œ ì‹¤íŒ¨");
            }

            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "ë‹µë³€ ë¶ˆê°€";
            addMsg("ai", aiText);

        } catch (e) {
            addMsg("error", `ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
        } finally {
            userInput.disabled = false;
            sendBtn.innerText = "ì „ì†¡";
            userInput.focus();
        }
    }

    function addMsg(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = type === 'ai' ? marked.parse(text) : text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { if(e.key==='Enter') sendMessage(); }
</script>
</body>
</html>
